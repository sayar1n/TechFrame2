# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ Rate Limiting

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ `docker-compose up -d` —É —Ç–µ–±—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã:

1. **X-Request-ID** ‚Äî —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **Rate Limiting** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

---

## üîç –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å X-Request-ID

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

–ü—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–π –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∫ –æ–±—ã—á–Ω–æ:

```bash
curl http://localhost:8000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"john","email":"john@test.com","password":"123456"}'
```

–í –æ—Ç–≤–µ—Ç–µ –±—É–¥–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Request-ID`:

```
X-Request-ID: f47ac10b-58cc-4372-a567-0e02b2c3d479
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–≤–æ–π X-Request-ID

–ú–æ–∂–µ—à—å –ø–µ—Ä–µ–¥–∞—Ç—å —Å–≤–æ–π ID:

```bash
curl http://localhost:8000/auth/register \
  -H "Content-Type: application/json" \
  -H "X-Request-ID: my-custom-id-123" \
  -d '{"username":"john","email":"john@test.com","password":"123456"}'
```

–¢–æ–≥–¥–∞ –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç `[my-custom-id-123]`.

---

## üìä –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π

### –ù–∞–π—Ç–∏ –≤—Å–µ –ª–æ–≥–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:

```bash
# –°–∫–æ–ø–∏—Ä—É–π X-Request-ID –∏–∑ –æ—Ç–≤–µ—Ç–∞
docker-compose logs | grep "f47ac10b-58cc-4372-a567-0e02b2c3d479"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
[Gateway] [f47ac10b] POST /auth/register
[Auth] [f47ac10b] POST /auth/register
[Auth] [f47ac10b] Creating user: john@test.com
[Auth] [f47ac10b] Response: 200
[Gateway] [f47ac10b] Response: 200
```

–í–∏–¥–∏—à—å **–≤–µ—Å—å –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞** —á–µ—Ä–µ–∑ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã!

---

## ‚è±Ô∏è Rate Limiting (–ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤)

### –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã:

| –ü—É—Ç—å | –õ–∏–º–∏—Ç | –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç |
|------|-------|----------------|
| `/auth/*` | 20/–º–∏–Ω—É—Ç—É | –ú–∞–∫—Å–∏–º—É–º 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é/–≤—Ö–æ–¥ –≤ –º–∏–Ω—É—Ç—É |
| `/projects/*` | 60/–º–∏–Ω—É—Ç—É | –ú–∞–∫—Å–∏–º—É–º 60 –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –≤ –º–∏–Ω—É—Ç—É |
| `/defects/*` | 60/–º–∏–Ω—É—Ç—É | –ú–∞–∫—Å–∏–º—É–º 60 –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ –≤ –º–∏–Ω—É—Ç—É |
| `/reports/*` | 30/–º–∏–Ω—É—Ç—É | –ú–∞–∫—Å–∏–º—É–º 30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –æ—Ç—á—ë—Ç–æ–≤ –≤ –º–∏–Ω—É—Ç—É |

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏?

**–û—Ç–≤–µ—Ç:**

```json
HTTP/1.1 429 Too Many Requests

{
  "error": "Rate limit exceeded: 20 per 1 minute"
}
```

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**

```
X-RateLimit-Limit: 20
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1701436800
```

- `Limit` ‚Äî –º–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
- `Remaining` ‚Äî —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å
- `Reset` ‚Äî –∫–æ–≥–¥–∞ —Å—á—ë—Ç—á–∏–∫ –æ–±–Ω—É–ª–∏—Ç—Å—è

---

## üß™ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å X-Request-ID

```bash
curl -i http://localhost:8000/health | grep X-Request-ID
```

–î–æ–ª–∂–µ–Ω –≤—ã–≤–µ—Å—Ç–∏:

```
X-Request-ID: <–∫–∞–∫–æ–π-—Ç–æ UUID>
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Rate Limiting

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 25 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥ (–ª–∏–º–∏—Ç 20)
for i in {1..25}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    -X POST http://localhost:8000/auth/register \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"test$i\",\"email\":\"test$i@test.com\",\"password\":\"123456\"}"
done
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
200  ‚Üê –ü–µ—Ä–≤—ã–µ 20 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç
200
...
200
429  ‚Üê –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
429
429
429
429
```

---

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã, –æ—Ç–∫—Ä–æ–π `backend/api_gateway/main.py`:

```python
@app.api_route("/auth/{path:path}", ...)
@limiter.limit("20/minute")  # ‚Üê –ò–∑–º–µ–Ω–∏ –∑–¥–µ—Å—å
async def auth_proxy(request: Request, path: str = ""):
    ...
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
@limiter.limit("100/minute")  # 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
@limiter.limit("10/second")   # 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
@limiter.limit("1000/hour")   # 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —á–∞—Å
```

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
docker-compose restart api-gateway
```

---

## üìñ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ —Ñ–∞–π–ª–µ `backend/TRACING_AND_RATE_LIMITING.md`

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è:

- ‚úÖ –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ (Rate Limiting)
- ‚úÖ –£–¥–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å X-Request-ID
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏


# –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–í `service_auth` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `auth_tokens`

```sql
CREATE TABLE auth_tokens (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,           -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    token TEXT NOT NULL UNIQUE,         -- JWT —Ç–æ–∫–µ–Ω
    is_active BOOLEAN DEFAULT TRUE,     -- –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ç–æ–∫–µ–Ω
    created_at DATETIME,                -- –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    expires_at DATETIME NOT NULL,       -- –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
    revoked_at DATETIME,                -- –í—Ä–µ–º—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–¥–ª—è logout)
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ

–ü—Ä–∏ –∫–∞–∂–¥–æ–º —É—Å–ø–µ—à–Ω–æ–º –ª–æ–≥–∏–Ω–µ (`POST /auth/token`):
- –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω
- –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `auth_tokens`
- **–í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è**

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ **–æ–¥–∏–Ω —Ç–æ–∫–µ–Ω** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

–ü—Ä–∏ –ª—é–±–æ–º –∑–∞—â–∏—â—ë–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- ‚úÖ –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å JWT (–ø–æ–¥–ø–∏—Å—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- ‚úÖ –ù–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î
- ‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ (`is_active = True`)
- ‚úÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (`expires_at > now`)

–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ ‚Üí **401 Unauthorized**

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`PUT /auth/users/{user_id}/role`):
- **–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –Ω–æ–≤–∞—è —Ä–æ–ª—å –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

### 4. Logout (–≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã)

–ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `POST /auth/logout`:
- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `is_active = False`
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ `revoked_at`

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### POST /auth/token (Login)
–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É, —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞.

**–ó–∞–ø—Ä–æ—Å:**
```
Content-Type: application/x-www-form-urlencoded

username=user123&password=secret
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
2. –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω
3. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `auth_tokens`
4. –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è

---

### POST /auth/logout
–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞.

**–ó–∞–ø—Ä–æ—Å:**
```
Authorization: Bearer <token>
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "Successfully logged out"
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –¢–æ–∫–µ–Ω –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π (`is_active = False`)
2. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ (`revoked_at`)
3. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Å —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–æ–º –±—É–¥—É—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã

---

### PUT /auth/users/{user_id}/role
–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è manager/admin).

**–ó–∞–ø—Ä–æ—Å:**
```
PUT /auth/users/5/role?new_role=manager
Authorization: Bearer <admin_token>
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": 5,
  "username": "user123",
  "email": "user@example.com",
  "role": "manager",
  "is_active": true,
  "created_at": "2025-12-01T10:00:00"
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
2. **–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è**
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –≤–æ–π—Ç–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Å –Ω–æ–≤–æ–π —Ä–æ–ª—å—é

## –§—É–Ω–∫—Ü–∏–∏ CRUD –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏

### `save_token(db, user_id, token, expires_at)`
–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –≤ –ë–î, –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—è –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### `get_token(db, token)`
–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–∑ –ë–î.

### `revoke_token(db, token)`
–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω (–¥–ª—è logout).

### `revoke_all_user_tokens(db, user_id)`
–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏).

### `cleanup_expired_tokens(db)`
–£–¥–∞–ª—è–µ—Ç –∏—Å—Ç—ë–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ –ë–î (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ cron).

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### Logout
```typescript
const logout = async () => {
  const token = localStorage.getItem('access_token');
  
  await fetch('http://localhost:8000/auth/logout', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  localStorage.removeItem('access_token');
  router.push('/login');
};
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã:

1. **–ö–æ–Ω—Ç—Ä–æ–ª—å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π** ‚Äî –º–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ —Ç–æ–∫–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã
2. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏/–ø–∞—Ä–æ–ª—è —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Å—Ç–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
4. **–ê—É–¥–∏—Ç** ‚Äî –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–æ–≥–¥–∞ —Ç–æ–∫–µ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω –∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω

### üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** ‚Äî –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `cleanup_expired_tokens()` —Ä–∞–∑ –≤ –¥–µ–Ω—å
2. **–ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–æ–≤** ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 30-60 –º–∏–Ω—É—Ç
3. **HTTPS** ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
4. **Refresh tokens** ‚Äî –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Å—Å–∏–π –¥–æ–±–∞–≤—å—Ç–µ refresh tokens

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ë–î

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ë–î –±–µ–∑ —Ç–∞–±–ª–∏—Ü—ã `auth_tokens`:

```bash
# –í Docker
docker compose exec auth-service python init_db.py

# –õ–æ–∫–∞–ª—å–Ω–æ
cd backend/service_auth
python init_db.py
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `auth_tokens`.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ª–æ–≥–∏–Ω–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
- –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã (–≤—ã–¥–∞–Ω–Ω—ã–µ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã) –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞
- –î–ª—è –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã: `docker compose down -v && docker compose up -d`

